name: pre-commit

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: actions/setup-python@v6
    - uses: pre-commit/action@v3.0.1

  clang-tidy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install LLVM 21
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 21
        sudo apt-get install -y clangd-21 clang-tidy-21

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libzmq3-dev libsqlite3-dev

    - name: Configure CMake
      run: cmake -B build -DBUILD_TESTING=OFF

    - name: Run clang-tidy
      run: ./run_clang_tidy.sh
